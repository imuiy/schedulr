<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Scheduler</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 30px; }
        
        .input-section { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .course-catalog { max-height: 600px; overflow-y: auto; }
        .search-box { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; margin-bottom: 15px; }
        
        .course-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 6px; background: #fafafa; cursor: pointer; transition: all 0.2s; }
        .course-item:hover { background: #e3f2fd; border-color: #2196F3; }
        .course-item.selected { background: #e3f2fd; border-color: #2196F3; border-width: 2px; }
        
        .course-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .course-code { font-weight: 600; font-size: 16px; color: #333; }
        .course-title { color: #666; font-size: 14px; margin-bottom: 8px; }
        .section-info { font-size: 12px; color: #888; }
        
        .selected-courses { background: #f9f9f9; padding: 15px; border-radius: 6px; min-height: 400px; }
        .selected-course-item { background: white; padding: 12px; margin-bottom: 10px; border-radius: 4px; border-left: 3px solid #2196F3; }
        .priority-control { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .priority-label { font-size: 13px; color: #666; }
        .priority-input { width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        
        button { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background: #1976D2; }
        button.secondary { background: #757575; }
        button.danger { background: #f44336; }
        button.small { padding: 5px 10px; font-size: 12px; }
        
        .blocked-time { background: #ffebee; padding: 10px; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        
        .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 13px; }
        
        /* Schedule table styles */
        .results { display: grid; grid-template-columns: repeat(auto-fill, minmax(900px, 1fr)); gap: 20px; margin-top: 20px; }
        .schedule-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .schedule-header { font-weight: bold; color: #2196F3; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #2196F3; padding-bottom: 10px; }
        
        .schedule-grid { display: flex; gap: 0; margin-top: 15px; }
        .time-column { width: 60px; flex-shrink: 0; }
        .time-marker { height: 60px; display: flex; align-items: flex-start; justify-content: center; font-size: 12px; color: #666; padding-top: 2px; border-top: 1px solid #e0e0e0; }
        .time-marker:first-child { border-top: none; }
        
        .day-columns { display: flex; flex: 1; border-left: 1px solid #e0e0e0; }
        .day-column { flex: 1; position: relative; border-right: 1px solid #e0e0e0; }
        .day-header { text-align: center; font-weight: 600; padding: 10px; background: #f5f5f5; border-bottom: 2px solid #ddd; font-size: 14px; }
        .day-content { position: relative; height: 660px; }
        
        .class-block { position: absolute; left: 2px; right: 2px; border-radius: 4px; padding: 8px; font-size: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 3px solid; }
        .class-name { font-weight: 600; margin-bottom: 2px; line-height: 1.2; }
        .class-section { font-size: 11px; opacity: 0.9; line-height: 1.2; }
        
        .course-colors { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .color-legend { display: flex; align-items: center; gap: 5px; font-size: 13px; }
        .color-box { width: 16px; height: 16px; border-radius: 3px; border: 1px solid #ddd; }
        
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-sections { background: #e3f2fd; color: #1976D2; }
        .badge-credits { background: #e8f5e9; color: #388E3C; margin-left: 5px; }
        
        .credit-summary { padding: 15px; background: #e3f2fd; border-radius: 6px; font-weight: 600; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Course Scheduler</h1>
        
        <div class="input-section">
            <h2 style="margin-bottom: 20px;">Select Your Courses</h2>
            
            <div class="two-column">
                <!-- Course Catalog -->
                <div>
                    <h3 style="margin-bottom: 10px;">Available Courses</h3>
                    <input type="text" class="search-box" id="search" placeholder="üîç Search courses..." onkeyup="filterCourses()">
                    <div class="course-catalog" id="course-catalog"></div>
                </div>
                
                <!-- Selected Courses -->
                <div>
                    <h3 style="margin-bottom: 10px;">Your Selected Courses (<span id="selected-count">0</span>)</h3>
                    <div class="selected-courses" id="selected-courses">
                        <div class="empty-state">Click courses on the left to add them</div>
                    </div>
                    <div class="credit-summary" id="credit-summary">
                        Selected: <span id="selected-credits">0</span> credits
                    </div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è Credit Constraints</h2>
            
            <div style="margin-bottom: 15px;">
                <label>Faculty/School:</label>
                <select id="faculty" onchange="updateOverloadOption()">
                    <option value="ksas">Krieger School of Arts & Sciences (19 credits max)</option>
                    <option value="engineering">Engineering (19.5 credits normal, can overload to 23.5)</option>
                </select>
            </div>
            
            <div id="overload-option" style="display: none; margin-bottom: 15px;">
                <label>
                    <input type="checkbox" id="allow-overload">
                    Allow overload (up to 23.5 credits)
                </label>
            </div>
        </div>

        <div class="input-section">
            <h2 style="margin-bottom: 15px;">‚è∞ Blocked Times (Optional)</h2>
            <div class="flex" style="margin-bottom: 10px;">
                <select id="blocked-day">
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                </select>
                <input type="time" id="blocked-start" value="12:00">
                <span>to</span>
                <input type="time" id="blocked-end" value="13:00">
                <button onclick="addBlockedTime()">+ Add</button>
            </div>
            <div id="blocked-times-container"></div>
        </div>

        <div class="input-section">
            <label>Maximum Schedules to Generate:</label>
            <input type="number" id="max-schedules" value="10" min="1" max="50" style="width: 100px;">
            <br><br>
            <button onclick="generateSchedules()" style="font-size: 16px; padding: 12px 30px;">üîç Generate Schedules</button>
        </div>

        <div id="results-container"></div>
    </div>

    <script>
        // Course database with credits
        const courseDatabase = {
            'CS101': {
                title: 'Introduction to Computer Science',
                credits: 3.0,
                sections: {
                    'L01': [
                        { day: 'Monday', start: '09:00', end: '10:30' },
                        { day: 'Wednesday', start: '09:00', end: '10:30' },
                        { day: 'Friday', start: '09:00', end: '10:30' }
                    ],
                    'L02': [
                        { day: 'Tuesday', start: '14:00', end: '15:30' },
                        { day: 'Thursday', start: '14:00', end: '15:30' }
                    ]
                }
            },
            'CS201': {
                title: 'Data Structures and Algorithms',
                credits: 3.0,
                sections: {
                    'A01': [
                        { day: 'Monday', start: '13:00', end: '14:30' },
                        { day: 'Wednesday', start: '13:00', end: '14:30' }
                    ],
                    'A02': [
                        { day: 'Tuesday', start: '10:00', end: '11:30' },
                        { day: 'Thursday', start: '10:00', end: '11:30' }
                    ]
                }
            },
            'MTH101': {
                title: 'Calculus I',
                credits: 4.0,
                sections: {
                    'L01': [
                        { day: 'Monday', start: '11:00', end: '12:30' },
                        { day: 'Wednesday', start: '11:00', end: '12:30' },
                        { day: 'Friday', start: '11:00', end: '12:30' }
                    ],
                    'L02': [
                        { day: 'Tuesday', start: '09:00', end: '10:30' },
                        { day: 'Thursday', start: '09:00', end: '10:30' },
                        { day: 'Friday', start: '09:00', end: '10:30' }
                    ]
                }
            },
            'PHY101': {
                title: 'Physics I',
                credits: 4.0,
                sections: {
                    'P01': [
                        { day: 'Tuesday', start: '13:00', end: '15:00' },
                        { day: 'Thursday', start: '13:00', end: '15:00' }
                    ],
                    'P02': [
                        { day: 'Monday', start: '14:00', end: '16:00' },
                        { day: 'Wednesday', start: '14:00', end: '16:00' }
                    ]
                }
            },
            'ENG101': {
                title: 'English Composition',
                credits: 3.0,
                sections: {
                    'E01': [{ day: 'Monday', start: '12:00', end: '13:30' }],
                    'E02': [{ day: 'Tuesday', start: '11:00', end: '12:30' }],
                    'E03': [{ day: 'Friday', start: '13:00', end: '14:30' }]
                }
            },
            'ELEC201': {
                title: 'Circuits and Electronics',
                credits: 3.0,
                sections: {
                    'X01': [{ day: 'Friday', start: '14:00', end: '15:30' }],
                    'X02': [{ day: 'Tuesday', start: '16:00', end: '17:30' }],
                    'X03': [{ day: 'Thursday', start: '16:00', end: '17:30' }]
                }
            }
        };

        let selectedCourses = {};

        const COLORS = [
            { bg: '#e3f2fd', border: '#2196F3', text: '#1976D2' },
            { bg: '#f3e5f5', border: '#9C27B0', text: '#7B1FA2' },
            { bg: '#e8f5e9', border: '#4CAF50', text: '#388E3C' },
            { bg: '#fff3e0', border: '#FF9800', text: '#F57C00' },
            { bg: '#fce4ec', border: '#E91E63', text: '#C2185B' },
            { bg: '#e0f2f1', border: '#009688', text: '#00796B' },
            { bg: '#f1f8e9', border: '#8BC34A', text: '#689F38' },
            { bg: '#ede7f6', border: '#673AB7', text: '#512DA8' },
        ];

        function initializeCatalog() {
            const catalog = document.getElementById('course-catalog');
            let html = '';
            
            for (const [code, course] of Object.entries(courseDatabase)) {
                const sectionCount = Object.keys(course.sections).length;
                html += `
                    <div class="course-item" id="catalog-${code}" onclick="toggleCourse('${code}')">
                        <div class="course-header">
                            <div>
                                <div class="course-code">${code}</div>
                                <div class="course-title">${course.title}</div>
                            </div>
                            <div>
                                <span class="badge badge-credits">${course.credits} credits</span>
                                <span class="badge badge-sections">${sectionCount} sections</span>
                            </div>
                        </div>
                        <div class="section-info">
                            ${Object.keys(course.sections).join(', ')}
                        </div>
                    </div>
                `;
            }
            
            catalog.innerHTML = html;
        }

        function toggleCourse(code) {
            if (selectedCourses[code]) {
                delete selectedCourses[code];
                document.getElementById(`catalog-${code}`).classList.remove('selected');
            } else {
                selectedCourses[code] = { priority: 5 };
                document.getElementById(`catalog-${code}`).classList.add('selected');
            }
            updateSelectedCourses();
        }

        function updateSelectedCourses() {
            const container = document.getElementById('selected-courses');
            const count = Object.keys(selectedCourses).length;
            document.getElementById('selected-count').textContent = count;
            
            // Calculate total credits
            let totalCredits = 0;
            for (const code of Object.keys(selectedCourses)) {
                totalCredits += courseDatabase[code].credits;
            }
            document.getElementById('selected-credits').textContent = totalCredits.toFixed(1);
            
            if (count === 0) {
                container.innerHTML = '<div class="empty-state">Click courses on the left to add them</div>';
                return;
            }
            
            let html = '';
            for (const [code, data] of Object.entries(selectedCourses)) {
                const course = courseDatabase[code];
                html += `
                    <div class="selected-course-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">${code} <span class="badge badge-credits">${course.credits} credits</span></div>
                                <div style="font-size: 13px; color: #666;">${course.title}</div>
                            </div>
                            <button class="danger small" onclick="removeCourse('${code}')">Remove</button>
                        </div>
                        <div class="priority-control">
                            <span class="priority-label">Priority:</span>
                            <input type="number" class="priority-input" min="1" max="10" value="${data.priority}" 
                                   onchange="updatePriority('${code}', this.value)">
                            <span style="font-size: 12px; color: #999;">(1=low, 10=high)</span>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function removeCourse(code) {
            delete selectedCourses[code];
            document.getElementById(`catalog-${code}`).classList.remove('selected');
            updateSelectedCourses();
        }

        function updatePriority(code, priority) {
            selectedCourses[code].priority = parseInt(priority);
        }

        function updateOverloadOption() {
            const faculty = document.getElementById('faculty').value;
            const overloadDiv = document.getElementById('overload-option');
            overloadDiv.style.display = faculty === 'engineering' ? 'block' : 'none';
        }

        function filterCourses() {
            const search = document.getElementById('search').value.toLowerCase();
            const items = document.querySelectorAll('.course-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'block' : 'none';
            });
        }

        function addBlockedTime() {
            const day = document.getElementById('blocked-day').value;
            const start = document.getElementById('blocked-start').value;
            const end = document.getElementById('blocked-end').value;
            
            const container = document.getElementById('blocked-times-container');
            const id = Date.now();
            const blockedDiv = document.createElement('div');
            blockedDiv.className = 'blocked-time';
            blockedDiv.id = `blocked-${id}`;
            blockedDiv.innerHTML = `
                <span>${day} ${start}-${end}</span>
                <button class="danger small" onclick="removeBlockedTime(${id})">Remove</button>
            `;
            container.appendChild(blockedDiv);
        }

        function removeBlockedTime(id) {
            document.getElementById(`blocked-${id}`).remove();
        }

        function generateSchedules() {
            if (Object.keys(selectedCourses).length === 0) {
                alert('Please select at least one course');
                return;
            }

            const coursesArray = [];
            
            for (const [code, data] of Object.entries(selectedCourses)) {
                const course = courseDatabase[code];
                const sections = [];
                
                for (const [sectionId, times] of Object.entries(course.sections)) {
                    sections.push({ id: sectionId, times: times });
                }
                
                coursesArray.push({
                    name: code,
                    priority: data.priority,
                    sections: sections,
                    credits: course.credits
                });
            }

            const blockedTimes = [];
            document.querySelectorAll('.blocked-time').forEach(el => {
                const text = el.textContent.trim();
                const match = text.match(/(\w+) (\d+:\d+)-(\d+:\d+)/);
                if (match) {
                    blockedTimes.push({
                        day: match[1],
                        start: match[2],
                        end: match[3]
                    });
                }
            });

            const maxSchedules = parseInt(document.getElementById('max-schedules').value);
            const faculty = document.getElementById('faculty').value;
            const allowOverload = document.getElementById('allow-overload').checked;

            fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    courses: coursesArray, 
                    blockedTimes, 
                    maxSchedules,
                    faculty: faculty,
                    allowOverload: allowOverload
                })
            })
            .then(r => r.json())
            .then(data => {
                displayResults(data);
            })
            .catch(err => {
                alert('Error generating schedules: ' + err);
            });
        }

        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function displayResults(data) {
            const container = document.getElementById('results-container');
            
            if (data.count === 0) {
                container.innerHTML = '<div class="input-section"><h2>No valid schedules found! Try adjusting priorities, allowing overload, or removing time blocks.</h2></div>';
                return;
            }

            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const startHour = 8;
            const endHour = 19;
            const hours = [];
            for (let h = startHour; h <= endHour; h++) {
                hours.push(`${h}:00`);
            }

            let html = `<div class="input-section"><h2>Found ${data.count} Valid Schedule(s)</h2></div><div class="results">`;
            
            data.schedules.forEach((scheduleData, scheduleIdx) => {
                const schedule = scheduleData.sections;
                const totalCredits = scheduleData.total_credits;
                
                const courseColors = {};
                schedule.forEach((course, idx) => {
                    courseColors[course.course] = COLORS[idx % COLORS.length];
                });

                html += `<div class="schedule-card">
                    <div class="schedule-header">
                        Schedule ${scheduleIdx + 1}
                        ${totalCredits ? `<span style="float: right; background: #4CAF50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px;">${totalCredits.toFixed(1)} credits</span>` : ''}
                    </div>
                    <div class="schedule-grid">
                        <div class="time-column">
                            <div style="height: 42px;"></div>`;
                
                hours.forEach(hour => {
                    html += `<div class="time-marker">${hour}</div>`;
                });
                
                html += `</div><div class="day-columns">`;
                
                days.forEach(day => {
                    html += `<div class="day-column">
                        <div class="day-header">${day}</div>
                        <div class="day-content">`;
                    
                    schedule.forEach(course => {
                        course.times.forEach(classTime => {
                            if (classTime.day === day) {
                                const startMinutes = timeToMinutes(classTime.start);
                                const endMinutes = timeToMinutes(classTime.end);
                                const startOfDay = startHour * 60;
                                
                                const topPosition = ((startMinutes - startOfDay) / 60) * 60;
                                const height = ((endMinutes - startMinutes) / 60) * 60;
                                
                                if (topPosition >= 0 && height > 0) {
                                    const color = courseColors[course.course];
                                    html += `<div class="class-block" style="
                                        top: ${topPosition}px;
                                        height: ${height}px;
                                        background: ${color.bg};
                                        border-left-color: ${color.border};
                                    ">
                                        <div class="class-name" style="color: ${color.text};">${course.course}</div>
                                        <div class="class-section">${course.section}</div>
                                        <div class="class-section">${classTime.start}-${classTime.end}</div>
                                    </div>`;
                                }
                            }
                        });
                    });
                    
                    html += `</div></div>`;
                });
                
                html += `</div></div>`;
                
                html += `<div class="course-colors">`;
                schedule.forEach(course => {
                    const color = courseColors[course.course];
                    html += `<div class="color-legend">
                        <div class="color-box" style="background: ${color.bg}; border-color: ${color.border};"></div>
                        <span>${course.course} (${course.section}) - ${course.credits} credits</span>
                    </div>`;
                });
                html += `</div></div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Initialize on load
        initializeCatalog();
    </script>
</body>
</html>